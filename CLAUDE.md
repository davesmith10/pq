# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Layout

```
Crystals/
├── kyber/ref/          — Kyber reference implementation + .so files (built separately)
├── kyber/avx2/         — Kyber AVX2 implementation + .so files (built separately)
├── dilithium/ref/      — Dilithium reference implementation + .so files (built separately)
├── dilithium/avx2/     — Dilithium AVX2 implementation + .so files (built separately)
├── msgpack-c/          — msgpack-c header-only library (vendored, C++ API) ← DO NOT DELETE
├── XKCP/               — eXtended Keccak Code Package: libXKCP.so + headers ← DO NOT DELETE
└── pq/                 — Main project (git root)
    ├── include/        — Shared domain headers (tray.hpp)
    ├── luke/           — Kyber KEM CLI tool (C++17, CMake)
    ├── geordi/src/     — Dilithium signature CLI tool (C++17, CMake)
    ├── scotty/         — Hybrid PQ+classical tray keygen tool (C++17, CMake)
    ├── obi-wan/        — Hybrid KEM file encryption tool (C++17, CMake)
    ├── msgpack/        — Tray binary encoding library + tests (C++17, CMake)
    ├── data/           — Sample .tray files (alice.tray, alice768.tray, alice1024.tray)
    ├── misc/           — Utilities (hashpass, etc.)
    ├── dist/           — Self-contained distribution (generated by package.sh)
    └── package.sh      — Distribution builder script
```

## Build Commands

**Build crypto libraries** (only needed once, or after upstream changes):
```bash
cd kyber/ref && make shared
cd kyber/avx2 && make shared
cd dilithium/ref && make shared
cd dilithium/avx2 && make shared
```

**Build luke** (Kyber KEM tool):
```bash
cmake -S pq/luke -B pq/luke/build
cmake --build pq/luke/build -j$(nproc)
# Binary: pq/luke/build/luke
```

**Build geordi** (Dilithium signature tool):
```bash
cmake -S pq/geordi/src -B pq/geordi/build
cmake --build pq/geordi/build -j$(nproc)
# Binary: pq/geordi/build/geordi
```

**Build scotty** (hybrid PQ+classical tray keygen):
```bash
cmake -S pq/scotty -B pq/scotty/build
cmake --build pq/scotty/build -j$(nproc)
# Binary: pq/scotty/build/scotty
```

**Build obi-wan** (hybrid KEM file encryption):
```bash
cmake -S pq/obi-wan -B pq/obi-wan/build
cmake --build pq/obi-wan/build -j$(nproc)
# Binary: pq/obi-wan/build/obi-wan
```

**Build msgpack** (tray binary encoding library + tests):
```bash
cmake -S pq/msgpack -B pq/msgpack/build
cmake --build pq/msgpack/build -j$(nproc)
# Library: pq/msgpack/build/libtraymsgpack.a
# Tests:   pq/msgpack/build/test_roundtrip
#          pq/msgpack/build/test_from_yaml
```

**Build self-contained distribution** (installs to `pq/dist/`):
```bash
cd pq
bash package.sh           # incremental build
bash package.sh --clean   # clean rebuild
```

## Testing

```bash
# obi-wan: encrypt → decrypt (YAML tray, defaults)
./pq/scotty/build/scotty keygen --alias alice --tray level2 > /tmp/alice.tray
echo "hello" > /tmp/plain.txt
./pq/obi-wan/build/obi-wan encrypt --tray /tmp/alice.tray /tmp/plain.txt > /tmp/out.armored
./pq/obi-wan/build/obi-wan decrypt --tray /tmp/alice.tray /tmp/out.armored | diff /tmp/plain.txt -

# obi-wan: KMAC + ChaCha20, msgpack tray
./pq/scotty/build/scotty keygen --alias bob --tray level3nist --out /tmp/bob.tray
./pq/obi-wan/build/obi-wan encrypt --tray /tmp/bob.tray --kdf KMAC --cipher ChaCha20 /tmp/plain.txt > /tmp/out2.armored
./pq/obi-wan/build/obi-wan decrypt --tray /tmp/bob.tray /tmp/out2.armored | diff /tmp/plain.txt -

# luke: keygen → encaps → decaps
./luke keygen --level 768 --impl ref --pk pk.pem --sk sk.pem
./luke encaps --level 768 --impl ref --pk pk.pem --kem kem.pem --ss ss1.bin
./luke decaps --level 768 --impl ref --sk sk.pem --kem kem.pem --ss ss2.bin
diff ss1.bin ss2.bin  # must match

# geordi: keygen → sign → verify
./geordi keygen --d3 --impl ref --pk pk.pem --sk sk.pem
./geordi sign --d3 --impl ref --sk sk.pem --msg file.txt --sig sig.pem
./geordi verify --d3 --impl ref --pk pk.pem --msg file.txt --sig sig.pem

# scotty: hybrid tray keygen
./scotty keygen --tray level3nist --alias alice             # YAML to stdout (default)
./scotty keygen --alias bob                                 # default tray: level2
./scotty keygen --tray level2nist --alias x --classiconly
./scotty keygen --tray level5nist --alias y --pqonly
./scotty keygen --tray level3nist --alias alice --summary   # human-readable summary
./scotty keygen --alias alice --out alice.tray              # binary msgpack to file
./scotty keygen --tray level3nist --alias bob --out bob.tray

# msgpack: round-trip tests
./pq/msgpack/build/test_roundtrip
./pq/msgpack/build/test_from_yaml pq/data/alice.tray
./pq/msgpack/build/test_from_yaml pq/data/alice768.tray
./pq/msgpack/build/test_from_yaml pq/data/alice1024.tray

# Kyber upstream tests (1000 cycles each level)
cd kyber/ref && make && ./test/test_kyber768

# Dilithium upstream tests (10000 cycles each level)
cd dilithium/ref && make && ./test/test_dilithium3
```

## Architecture

### Shared Design Pattern (luke and geordi)
Both tools follow the same structure:
- `main.cpp` — argument parsing and command dispatch
- `*_api.hpp` — `extern "C"` declarations for all crypto library functions (6 variants each: 3 levels × 2 impls)
- `*_ops.{hpp,cpp}` — thin C++ wrappers returning `std::vector<uint8_t>`
- `pem_io.{cpp,hpp}` — PEM armor (Base64 with `-----BEGIN/END KYBER*/DILITHIUM* ...-----` headers)
- `base64.{cpp,hpp}` — Base64 encode/decode

### obi-wan Architecture
obi-wan encrypts files using hybrid KEM — both the classical and PQ KEM slots from a scotty tray.
- `obi-wan/src/main.cpp` — arg parsing, encrypt/decrypt dispatch, slot selection by `alg_name`
- `obi-wan/src/kyber_api.hpp` — `extern "C"` for Kyber{512,768,1024} ref `enc`/`dec`
- `obi-wan/src/kyber_kem.{hpp,cpp}` — `encaps()`/`decaps()` wrappers
- `obi-wan/src/ec_kem.{hpp,cpp}` — ECDH encaps/decaps (X25519 via raw key API; P-256/384/521 via `OSSL_PARAM_BLD`)
- `obi-wan/src/kdf.hpp` — header-only SHAKE256 and KMAC256 key derivation using XKCP
- `obi-wan/src/symmetric.hpp` — header-only AES-256-GCM and ChaCha20-Poly1305 encrypt/decrypt
- `obi-wan/src/tray_reader.{hpp,cpp}` — load YAML or msgpack tray (auto-detect by first byte)
- `obi-wan/src/armor.{hpp,cpp}` — binary wire format pack/unpack + base64 armor/dearmor
- `obi-wan/src/base64.{hpp,cpp}` — copied from scotty

**XKCP dependency**: `XKCP/bin/x86-64/libXKCP.so` (linked by full path) + headers at
`XKCP/bin/x86-64/libXKCP.so.headers/` (`SimpleFIPS202.h` for SHAKE256, `SP800-185.h` for KMAC256).
Do not delete the `XKCP/` directory.

**fips202 linking**: obi-wan only needs Kyber (no Dilithium), so a single `kyber_fips202_obj`
OBJECT library is compiled and `-rdynamic` is used (same pattern as scotty).

**KDF input construction**:
- SHAKE256: `SHAKE256(len32(SS_cl)||SS_cl||len32(SS_pq)||SS_pq||len32(CT_cl)||CT_cl||len32(CT_pq)||CT_pq, 32B)`
- KMAC256: `KMAC256(key=SS_cl, msg=len32(SS_pq)||...|CT_pq, custom="hybrid-kem-file-encryption-v1", 256b)`
- KMAC256 lengths are passed in **bits** as required by the XKCP API.

**Slot selection**: finds the first slot with `alg_name` in `{X25519,P-256,P-384,P-521}` (classical KEM)
and the first slot with `alg_name` starting with `Kyber` (PQ KEM). Works with full, classiconly, and pqonly
trays as long as both required slot types are present.

### scotty Architecture
scotty generates **hybrid trays** — named bundles of paired PQ+classical key slots.
- `pq/include/tray.hpp` — shared `Tray`/`Slot` structs and `TrayType` enum (domain model, not scotty-internal)
- `scotty/src/tray.cpp` — `make_tray()` implementation, UUID + ISO 8601 timestamps
- `ec_ops.{hpp,cpp}` — OpenSSL EVP keygen for X25519, Ed25519, P-256, P-384, P-521
- `kyber_ops.{hpp,cpp}` + `kyber_api.hpp` — ref-only Kyber keygen wrapper
- `dilithium_ops.{hpp,cpp}` + `dilithium_api.hpp` — ref-only Dilithium keygen wrapper
- `yaml_io.{hpp,cpp}` — yaml-cpp YAML emission with literal block scalars
- `base64.{hpp,cpp}` — copied from luke
- `pq/msgpack/src/tray_pack.{hpp,cpp}` — compiled directly into scotty for `--out` binary output

**Output modes**: default = YAML stdout; `--out <file>` = binary msgpack; `--summary` = text summary.

**scotty fips202 linking strategy**: Both kyber and dilithium ref .so files need `fips202`
symbols from different namespaces (`pqcrystals_kyber_fips202_ref_*` vs
`pqcrystals_dilithium_fips202_ref_*`). Since both fips202.so files share the same filename
(different sonames would clash at runtime), scotty instead compiles both `fips202.c` files
directly into the binary as CMake OBJECT libraries with different `-I` include paths
(producing different symbol names), then uses `-rdynamic` to export them to the .so files.

### msgpack Architecture
`pq/msgpack/src/tray_pack.{hpp,cpp}` is shared between scotty and the standalone library.
scotty compiles `tray_pack.cpp` directly (see scotty CMakeLists.txt). The `pq/msgpack/`
CMake project builds a standalone `libtraymsgpack.a` and tests for other consumers.

- `pq/include/tray.hpp` — shared domain model included by both scotty and msgpack
- `msgpack/src/tray_pack.hpp` — public API: `tray_mp::pack`, `unpack`, `pack_to_file`, `unpack_from_file`
- `msgpack/src/tray_pack.cpp` — implementation using msgpack-c header-only API
- `msgpack/test/test_roundtrip.cpp` — in-memory mock Tray round-trip test (no external deps)
- `msgpack/test/test_from_yaml.cpp` — parses real `.tray` YAML → pack → unpack → verify

**Wire format**: top-level msgpack map with short string keys:
```
map(7) { "v"→uint, "a"→str, "t"→str, "id"→str, "cr"→str, "ex"→str,
         "sl"→array[ map{ "alg"→str, "pk"→bin, "sk"→bin (optional) } ] }
```
pk/sk are stored as raw bytes (msgpack BIN), not base64. Achieves ~67% of YAML file size.

**Dependencies**: msgpack-c header-only at `Crystals/msgpack-c/include` — **required by both
scotty and msgpack builds**. Do not delete `msgpack-c/`. Compile with `-DMSGPACK_NO_BOOST`
(no Boost needed). `test_from_yaml` also links yaml-cpp and scotty's `base64.cpp`.

### Shared Library Linking Strategy
All 6 crypto variants are linked into each binary simultaneously (not dynamically dispatched via dlopen). Full `.so` paths are used in `target_link_libraries` to avoid linker collisions between `fips202_ref` and `fips202_avx2` libraries which share identical sonames but different symbol namespaces.

`randombytes()` is not exported by any Kyber/Dilithium `.so` — it must be compiled directly into each binary from `kyber/ref/randombytes.c` or `dilithium/ref/randombytes.c`.

### RPATH Setup
- **Development builds**: RPATH set to absolute paths of the `.so` directories
- **Distribution builds**: RPATH set to `$ORIGIN/../lib/kyber`, `$ORIGIN/../lib/dilithium`, or `$ORIGIN/../lib/scotty`
- Kyber and Dilithium use **separate** `lib/` directories in `dist/` because their `fips202` libraries conflict in symbol space

### luke-only: Hybrid Encryption
`encrypt`/`decrypt` commands combine Kyber (KEM) with AES-256-GCM for arbitrary data encryption. Output is a `.lukb` binary bundle (magic + version + level + kem_ct + nonce + tag + ciphertext). Uses OpenSSL EVP API via `aes_gcm.hpp`.

### Key Size Constants (from `*_api.hpp`)
| Level | Public Key | Secret Key | Ciphertext/Sig |
|-------|-----------|-----------|----------------|
| Kyber512 | 800 B | 1632 B | 768 B |
| Kyber768 | 1184 B | 2400 B | 1088 B |
| Kyber1024 | 1568 B | 3168 B | 1568 B |
| Dilithium2 | 1312 B | **2560 B** | 2420 B |
| Dilithium3 | 1952 B | **4032 B** | 3309 B |
| Dilithium5 | 2592 B | **4896 B** | 4627 B |

(Note: Dilithium sk sizes differ from NIST ML-DSA spec; use values from `dilithium/ref/api.h`)

## CMakeLists.txt Paths
- luke: `cmake -S pq/luke -B pq/luke/build` (CMakeLists.txt at `pq/luke/CMakeLists.txt`)
- geordi: `cmake -S pq/geordi/src -B pq/geordi/build` (CMakeLists.txt at `pq/geordi/src/CMakeLists.txt`)
- scotty: `cmake -S pq/scotty -B pq/scotty/build` (CMakeLists.txt at `pq/scotty/CMakeLists.txt`)
  - includes `../msgpack/src` and `../../msgpack-c/include` for the tray_pack module
- obi-wan: `cmake -S pq/obi-wan -B pq/obi-wan/build` (CMakeLists.txt at `pq/obi-wan/CMakeLists.txt`)
  - includes `../msgpack/src`, `../../msgpack-c/include`, `../../XKCP/bin/x86-64/libXKCP.so.headers`
  - links `../../XKCP/bin/x86-64/libXKCP.so` and kyber ref `.so` files by full path
- msgpack: `cmake -S pq/msgpack -B pq/msgpack/build` (CMakeLists.txt at `pq/msgpack/CMakeLists.txt`)
- All use `../../kyber` / `../../dilithium` relative paths to find upstream `.so` files
- msgpack and scotty both use `../../msgpack-c/include` and `../include` (for `tray.hpp`)

## Exit Codes (all tools)
- `0` — success
- `1` — usage/argument error
- `2` — crypto failure (decaps mismatch, invalid signature)
- `3` — I/O error (file not found, wrong PEM header level)
